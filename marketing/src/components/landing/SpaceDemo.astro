---
/**
 * SpaceDemo - Static SVG representation of Space View
 * Configurable via props for use in different contexts
 */

const COLORS = {
  backgroundDark: '#231F20',
  text: '#FBD19F',
  border: '#51853B',
};

const STAGE_COLORS: Record<string, string> = {
  germinating: '#a08060',
  seedling: '#6aA050',
  vegetative: '#51853B',
  flowering: '#15472C',
  harvested: '#3a3530',
};

const SPACE_COLORS = ['#51853B', '#F15D43', '#4ECDC4', '#F7DC6F', '#E67E22', '#9B59B6'];

// Types
interface Plant {
  id: string;
  code: string;
  stage: 'germinating' | 'seedling' | 'vegetative' | 'flowering' | 'harvested';
  gridX: number;
  gridY: number;
  size?: 1 | 2 | 4;
}

interface Space {
  id: string;
  name: string;
  gridWidth: number;
  gridHeight: number;
  plants: Plant[];
  colorIndex?: number;
}

interface Props {
  spaces: Space[];
  cellSize?: number;
  gap?: number;
  padding?: number;
}

const {
  spaces,
  cellSize = 56,
  gap = 40,
  padding = 30
} = Astro.props;

// Calculate canvas dimensions
const spaceWidths = spaces.map(s => s.gridWidth * cellSize);
const totalSpaceWidth = spaceWidths.reduce((sum, w) => sum + w, 0);
const totalGaps = (spaces.length - 1) * gap;
const WIDTH = padding * 2 + totalSpaceWidth + totalGaps;

const maxSpaceHeight = Math.max(...spaces.map(s => s.gridHeight * cellSize));
const HEIGHT = padding * 2 + 16 + maxSpaceHeight; // 16 for label above

// Calculate space positions
let xOffset = padding;
const spacePositions = spaces.map((space, idx) => {
  const pos = { x: xOffset, y: padding + 16 };
  xOffset += space.gridWidth * cellSize + gap;
  return pos;
});
---

<svg
  viewBox={`0 0 ${WIDTH} ${HEIGHT}`}
  class="space-demo"
  xmlns="http://www.w3.org/2000/svg"
  preserveAspectRatio="xMidYMid meet"
>
  <!-- Background -->
  <rect x="0" y="0" width={WIDTH} height={HEIGHT} fill={COLORS.backgroundDark} />

  <!-- Spaces -->
  {spaces.map((space, spaceIdx) => {
    const pos = spacePositions[spaceIdx];
    const spaceWidth = space.gridWidth * cellSize;
    const spaceHeight = space.gridHeight * cellSize;
    const spaceColor = SPACE_COLORS[space.colorIndex ?? spaceIdx % SPACE_COLORS.length];

    return (
      <g class="space">
        <!-- Space label (above) -->
        <text
          x={pos.x + 4}
          y={pos.y - 6}
          fill={spaceColor}
          font-size="10"
          font-family="'Space Mono', monospace"
          opacity="0.8"
        >
          {space.name}
        </text>

        <!-- Space background -->
        <rect
          x={pos.x}
          y={pos.y}
          width={spaceWidth}
          height={spaceHeight}
          fill={COLORS.backgroundDark}
        />

        <!-- Space grid lines -->
        {Array.from({ length: space.gridWidth + 1 }).map((_, i) => (
          <line
            x1={pos.x + i * cellSize}
            y1={pos.y}
            x2={pos.x + i * cellSize}
            y2={pos.y + spaceHeight}
            stroke={spaceColor}
            stroke-width="1"
            opacity="0.4"
          />
        ))}
        {Array.from({ length: space.gridHeight + 1 }).map((_, i) => (
          <line
            x1={pos.x}
            y1={pos.y + i * cellSize}
            x2={pos.x + spaceWidth}
            y2={pos.y + i * cellSize}
            stroke={spaceColor}
            stroke-width="1"
            opacity="0.4"
          />
        ))}

        <!-- Space border -->
        <rect
          x={pos.x}
          y={pos.y}
          width={spaceWidth}
          height={spaceHeight}
          fill="none"
          stroke={spaceColor}
          stroke-width="2"
        />

        <!-- Plants in this space -->
        {space.plants.map((plant) => {
          const plantWidth = plant.size === 4 ? 2 : 1;
          const plantHeight = (plant.size ?? 1) >= 2 ? 2 : 1;
          const inset = 2;

          const plantX = pos.x + plant.gridX * cellSize;
          const plantY = pos.y + plant.gridY * cellSize;
          const pWidth = plantWidth * cellSize;
          const pHeight = plantHeight * cellSize;

          return (
            <g class="plant">
              <!-- Plant background -->
              <rect
                x={plantX + inset}
                y={plantY + inset}
                width={pWidth - 2 * inset}
                height={pHeight - 2 * inset}
                fill={STAGE_COLORS[plant.stage]}
                opacity="0.95"
              />

              <!-- Plant code label -->
              {plant.code && (
                <text
                  x={plantX + pWidth / 2}
                  y={plantY + pHeight / 2}
                  fill={COLORS.text}
                  font-size="12"
                  font-weight="bold"
                  font-family="'Space Mono', monospace"
                  text-anchor="middle"
                  dominant-baseline="middle"
                >
                  {plant.code}
                </text>
              )}
            </g>
          );
        })}
      </g>
    );
  })}
</svg>

<style>
  .space-demo {
    width: 100%;
    height: auto;
    display: block;
  }
</style>
